<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Scroll Load More with Cards</title>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Nunito:ital,wght@0,200..1000;1,200..1000&display=swap"
      rel="stylesheet"
    />

    <link rel="stylesheet" href="css/output.css" />
    <link rel="stylesheet" href="css/app.css" />
    <style>
      .body {
        font-family: "Nunito", sans-serif;
      }
      .scroll-container {
        display: flex;
        overflow-x: auto;
        gap: 48px;
        padding: 10px;
        border: 1px solid #ccc;
        height: 900px;
        align-items: center;
        position: relative;
      }

      .loader {
        width: 40px;
        height: 40px;

        animation: spin 1s linear infinite;
        flex: 0 0 auto;

        background-image: url("public/home1/loading.svg");
        background-repeat: no-repeat;
        background-position: center;
        background-size: 100%;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }

        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>

  <body class="bg-red-50">
    <div id="container" class="scroll-container relative">
      <button
        class="fixed left-5 transform -translate-y-1/2 z-99"
        id="left-arrow"
      >
        <img
          src="public/home1/arrow-right.svg"
          width="40"
          height="40"
          alt=""
          style="transform: rotate(180deg)"
        />
      </button>
      <button
        class="fixed right-5 transform -translate-y-1/2 z-99"
        id="right-arrow"
      >
        <img src="public/home1/arrow-right.svg" width="40" height="40" alt="" />
      </button>
    </div>

    <button id="back-to-active" class="fixed top-10 left-0-5 z-99">
      <img src="public/home1/back-to-active.png" alt="back" />
    </button>

    <script>
      const container = document.getElementById("container");
      const totalItems = 100;
      const activeItem = 41;
      const visibleBefore = 10;
      const visibleAfter = 10;
      const loadedItems = new Set();
      let isLoading = false;
      let lastLoadDirection = null;

      function createItem(index) {
        // Test big card
        if (index === 49) {
          return `
              <div class="course-card test-card">
      <div class="relative w-full">
        <div class="test-card-title">Mid-term Test</div>
        <div class="mb-5 mx-6">
          <div class="flex items-center space-x-5">
            <div
              class="level-modal-tag bg-white"
              style="height: 105px; width: 172px"
            >
              <img
                width="60"
                height="60"
                src="/public/icons/tag-units.svg"
                alt="tag"
              />
              <div class="flex items-center gap-2">
                <p class="heading-h3 primary-green">20</p>
                <p class="button-xs pb-1">Units</p>
              </div>
            </div>
            <div
              id="small-scroll-exception"
              class="space-y-4 flex-1 pr-1 h-[105px] overflow-y-auto"
            >
              <div class="h-10 level-button-unit w-full bg-grayscale-white">
                <button class="level-left-part w-19 !text-base button-s">
                  Unit 1
                </button>
                <button
                  class="level-right-part !text-base button-l line-clamp-1"
                >
                  Lesson 1 he as alo
                </button>
              </div>
              <div class="h-10 level-button-unit w-full bg-grayscale-white">
                <button class="level-left-part w-19 button-s">Unit 2</button>
                <button
                  class="level-right-part !text-base button-l line-clamp-1"
                >
                  Lesson 2
                </button>
              </div>
              <div class="h-10 level-button-unit w-full bg-grayscale-white">
                <button class="level-left-part w-19 button-s">Unit 3</button>
                <button
                  class="level-right-part !text-base button-l line-clamp-1"
                >
                  Lesson 3
                </button>
              </div>
            </div>
          </div>
        </div>
        <div class="grid grid-cols-2 m-6 items-stretch gap-5.5">
          <div
            class="flex-1 border-2 p-5 rounded-2xl bg-[#FFFBFBCC] border-black/10 flex justify-center"
            id="slide-1"
          >
            <div class="flex flex-col justify-between w-full">
              <div class="flex flex-col justify-between h-full">
                <div class="space-y-5">
                  <div class="flex justify-center items-center">
                    <img
                      class="rounded-full -ml-5"
                      width="48"
                      height="48"
                      src="public/exam2/mic.png"
                      alt="avatar"
                    />
                    <p class="button-l !text-lg text-black">Kỹ năng Nói</p>
                  </div>

                  <div class="flex flex-col items-center">
                    <div class="avatar-bg">
                      <img
                        class="rounded-full p-1"
                        width="64"
                        height="64"
                        src="public/images/avatar1.png"
                        alt="avatar"
                      />
                    </div>
                    <div class="grayscale-dark-gray button-l mt-5">Cô Tina</div>
                  </div>

                  <div
                    class="text-[15px] text-center !leading-[160%] text-[#252525]"
                  >
                    Bạn sẽ vào lớp học online trả lời câu hỏi của Giáo viên và
                    được chấm điểm. Nhớ khi đến giờ, bấm
                    <strong>"Vào lớp"</strong> để bắt đầu nhé!
                  </div>
                </div>

                <div>
                  <div
                    class="w-full mt-6 flex flex-col items-center button-shadow bg-[#FF9800] px-2 py-3 space-y-3"
                  >
                    <div class="flex items-center">
                      <img
                        width="36"
                        height="36"
                        class="mr-3"
                        src="public/icons/rocket.svg"
                        alt="avatar"
                      />
                      <p class="button-l text-white">Vào lớp</p>
                    </div>

                    <div
                      class="flex items-center w-full bg-white inner-blur-inner-b4-20 justify-between"
                      style="
                        padding: 10px 8px;
                        border-radius: 12px;
                        border: 2px solid rgba(0, 0, 0, 0.05);
                      "
                    >
                      <div
                        class="flex items-center button-m grayscale-dark-gray"
                      >
                        <img
                          width="24"
                          height="24"
                          class="mr-2"
                          src="public/icons/clock.svg"
                          alt="clock"
                        />04:59
                      </div>
                      <div
                        class="flex items-center caption-m grayscale-dark-gray"
                      >
                        <img
                          width="24"
                          height="24"
                          class="mr-2"
                          src="public/icons/calendar-gray.svg"
                          alt="calendar"
                        />Thứ 2 - 12/12/2024
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="flex-1 flex flex-col justify-between">
            <div
              class="border-2 p-5 rounded-2xl bg-[#FFFBFBCC] border-black/10 flex justify-center h-full"
            >
              <div class="flex flex-col justify-between w-full">
                <div class="space-y-6">
                  <div class="flex justify-center items-center">
                    <img
                      class="rounded-full -ml-5"
                      width="36"
                      height="36"
                      src="public/exam2/speaker.png"
                      alt="avatar"
                    />
                    <p class="button-l !text-lg text-black">
                      Kỹ năng Nghe - Đọc - Viết
                    </p>
                  </div>

                  <div class="flex flex-col items-center">
                    <div class="text-[#FF9800] text-[40px] mb-2 heading-h3">
                      30:00
                    </div>
                    <div class="text-[15px] font-bold">Thời gian làm</div>
                  </div>

                  <div
                    class="text-[15px] text-center !leading-[160%] text-[#252525]"
                  >
                    Bạn sẽ làm bài kiểm tra trên máy, gồm các phần Nghe hiểu,
                    Đọc - Viết.
                  </div>
                </div>

                <a
                  href="#congrats-modal"
                  uk-toggle
                  class="grayscale-white h-12 mt-12.5 btn-animation flex justify-center items-center heading-h3 px-5 button-hover button-primary bg-[#00B26B] !text-2xl"
                >
                  Làm bài kiểm tra
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>`;
        }

        // Unit card
        if (index === 50) {
          return `
            <div
      class="course-card bg-[url('/public/home1/unit.svg')] flex-none bg-size-cover bg-no-repeat w-50 h-[508px] flex items-end justify-center"
    >
      <div class="text-center text-2xl font-bold text-[#454575] mb-25">
        <p>Unit 4</p>
        <p>Emotional</p>
      </div>
    </div>`;
        }

        // Future card
        if (index > 41) {
          return `
           <div class="card3-lesson course-card">
      <img
        class="absolute -top-8 -right-8"
        width="76"
        height="76"
        src="public/home1/lesson-lock.svg"
        alt="avatar"
      />
      <div class="card3-header opacity-40">
        <div class="card3-header-subtitle">
          <p class="">Unit 3</p>
          <div class="w-[1px] my-1 h-4.5 bg-black/20"></div>
          <p>Lesson 3</p>
        </div>
        <h3 class="card3-header-title">I can swim</h3>
      </div>
      <div class="card3-content">
      ${
        index % 2 === 0
          ? ` <div class="card3-content-teacher opacity-40">
          <img
            class="rounded-full"
            width="100"
            height="100"
            src="public/images/avatar1.png"
            alt="avatar"
          />
          <p class="card3-content-teacher-name">Cô Tina</p>
        </div>`
          : `<div class="card3-content-unit opacity-40">
          <p class="card3-content-unit-name">
            <img
              class="rounded-full mr-3"
              width="32"
              height="32"
              src="public/home1/book.svg"
              alt="avatar"
            />Unit 3
          </p>
          <div class="card3-content-unit-list">
            <div>Unit 2: You can sing</div>
            <div>Unit 3 You can talk</div>
          </div>
        </div>`
      }
       
        
      </div>
      <div class="card3-footer">
        <div
          class="m-6 flex items-center justify-center button-shadow bg-[#D8EDDD] px-2 py-3 space-y-3"
          style="flex-direction: column"
        >
          <div class="flex items-center justify-center">
            <img
              width="32"
              height="32"
              class="mr-3"
              src="public/home1/clock-color.svg"
              alt="avatar"
            />
            <p class="button-l grayscale-dark-gray ml-3">2 ngày nữa</p>
          </div>
          <div
            class="flex-items-center w-full bg-white inner-blur-inner-b4-20"
            style="
              padding: 10px 8px;
              justify-content: space-between;
              border-radius: 12px;
              border: 2px solid rgba(0, 0, 0, 0.05);
            "
          >
            <div
              class="flex items-center justify-center caption-s grayscale-dark-gray"
            >
              20:00 - Thứ 2 12/12/2024
            </div>
          </div>
        </div>
      </div>
    </div>`;
        }

        // Current card
        if (index === 41) {
          return `
  <div class="card2-lesson course-card active">
      <img
        class="absolute -top-8 -right-8"
        width="80"
        height="80"
        src="public/home1/lesson-current.svg"
        alt="avatar"
      />
      <div class="card2-header">
        <div class="card2-header-subtitle">
          <p class="">Unit 3</p>
          <div class="w-[1px] my-1 h-4.5 bg-black/20"></div>
          <p>Lesson 3</p>
        </div>
        <h3 class="card2-header-title">I can swim</h3>
      </div>
      <div class="card2-content">
        <div class="card2-content-teacher">
          <img
            class="rounded-full"
            width="160"
            height="160"
            src="public/images/avatar1.png"
            alt="avatar"
          />
          <p class="card2-content-teacher-name !text-white">Cô Tina</p>
        </div>
        <div
          class="flex items-center button-shadow m-6 bg-[#FF9800] px-3 py-4 space-y-3"
          style="flex-direction: column"
        >
          <div class="flex items-center justify-between w-full">
            <img
              width="40"
              height="40"
              src="public/home1/rocket.svg"
              alt="avatar"
            />
            <p class="button-l text-white ml-3">Vào lớp</p>
            <div class="flex items-center button-m text-white">
              <img
                width="16"
                height="16"
                class="mr-2"
                src="public/home1/clock-white.svg"
                alt="avatar"
              />04:59
            </div>
          </div>
          <div
            class="flex items-center justify-center w-full bg-white inner-blur-inner-b4-20"
            style="
              padding: 10px 8px;
              border-radius: 12px;
              border: 2px solid rgba(0, 0, 0, 0.05);
            "
          >
            <div class="flex items-center button-m grayscale-dark-gray">
              <img
                width="16"
                height="16"
                class="mr-2"
                src="public/home1/clock-black.svg"
                alt="avatar"
              />
            </div>
            <div class="flex items-center caption-m grayscale-dark-gray">
              04:59 - Thứ 2 - 12/12/2024
            </div>
          </div>
        </div>
        <div
          class="h-12 my-6 text-xl font-bold text-white flex justify-center items-center"
        >
          <img
            src="public/home1/book-white.svg"
            width="20"
            class="mr-3"
            height="20"
            alt="upload"
          />Xem nội dung
        </div>
        <div class="card2-content-progress">
          <div class="card2-content-progress-point w-full grid grid-cols-3">
            <div class="items-center flex justify-center">
              <p class="w-full"></p>
              <img
                src="public/home1/active-point-green.svg"
                width="32"
                height="32"
                alt="upload"
              />
              <div class="w-full h-0.5 bg-white"></div>
            </div>
            <div class="items-center flex justify-center">
              <div class="w-full h-0.5 bg-white"></div>
              <div class="size-5 flex-none rounded-full bg-[#CAE2BD]"></div>
              <div class="w-full h-0.5 bg-white"></div>
            </div>
            <div class="items-center flex justify-center">
              <div class="w-full h-0.5 bg-white"></div>
              <div class="size-5 flex-none rounded-full bg-[#CAE2BD]"></div>
              <p class="w-full"></p>
            </div>
          </div>
          <div class="card2-content-progress-desc w-full grid grid-cols-3">
            <div class="text-white">Xem nội dung</div>
            <div class="text-white/60">Vào lớp</div>
            <div class="text-white/60">Luyện tập</div>
          </div>
        </div>
      </div>
    </div>
            `;
        }

        // Past card
        return `
                <div class="card-lesson course-card">
      <img
        class="absolute -top-8 -right-8"
        width="76"
        height="76"
        src="public/home1/lesson-active.svg"
        alt="avatar"
      />
      <div class="card-header">
        <div class="card-header-subtitle">
          <p class="">Unit 3</p>
          <div class="w-[1px] my-1 h-4.5 bg-black/20"></div>
          <p>Lesson 3</p>
        </div>
        <h3 class="card-header-title">I can swim</h3>
      </div>
      <div class="card-content">
        <div class="card-content-teacher">
          <img
            class="rounded-full"
            width="100"
            height="100"
            src="public/images/avatar1.png"
            alt="avatar"
          />
          <p class="card-content-teacher-name">Cô Tina</p>
        </div>
        <div class="card-content-buttons">
          <div class="card-content-buttons-left">
            <img
              src="public/home1/book1.svg"
              width="20"
              class="mr-3"
              height="20"
              alt="upload"
            />Nội dung
          </div>
          <button
            class="card-content-buttons-right flex items-center px-4 bg-[#00B26B] text-white button-primary btn-animation"
          >
            <img
              src="public/home1/game-pad.svg"
              class="mr-3"
              width="32"
              height="32"
              alt="upload"
            />
            Luyện tập
          </button>
        </div>
        <div class="card-content-schedule">
          <span class="card-content-time">20:00 - Thứ 2 12/12/2024</span>
        </div>
        <div class="card-content-progress">
          <div class="card-content-progress-point w-full grid grid-cols-3">
            <div class="items-center flex justify-center">
              <p class="w-full"></p>
              <img
                src="public/home1/active-point.svg"
                width="32"
                height="32"
                alt="upload"
              />
              <div class="w-full h-0.5 bg-[#00B26B]"></div>
            </div>
            <div class="items-center flex justify-center">
              <div class="w-full h-0.5 bg-[#00B26B]"></div>
              <img
                src="public/home1/active-point.svg"
                width="32"
                height="32"
                alt="upload"
              />
              <div class="w-full h-0.5 bg-[#E5E5E5]"></div>
            </div>
            <div class="items-center flex justify-center">
              <div class="w-full h-0.5 bg-[#E5E5E5]"></div>
              <div
                class="size-5 flex-none rounded-full bg-[#F4F4F4] border border-white"
              ></div>
              <p class="w-full"></p>
            </div>
          </div>
          <div class="card-content-progress-desc w-full grid grid-cols-3">
            <div>Xem nội dung</div>
            <div>Vào lớp</div>
            <div class="text-black/40">Luyện tập</div>
          </div>
        </div>
      </div>
    </div>
          `;
      }

      function insertLoader(prepend) {
        const loader = document.createElement("div");
        loader.className = "loader";
        if (prepend) {
          container.prepend(loader);
        } else {
          container.appendChild(loader);
        }
        return loader;
      }

      async function loadItems(start, end, prepend = false) {
        if (isLoading) return;
        isLoading = true;

        const loader = insertLoader(prepend);
        const prevScrollLeft = container.scrollLeft;
        const prevScrollWidth = container.scrollWidth;

        await new Promise((resolve) => setTimeout(resolve, 1000));
        loader.remove();

        const items = [];
        for (let i = start; i <= end; i++) {
          if (i < 1 || i > totalItems || loadedItems.has(i)) continue;
          const el = createItem(i);
          items.push(el);
          loadedItems.add(i);
        }

        if (items.length === 0) {
          isLoading = false;
          return;
        }

        if (prepend) {
          items
            .reverse()
            .forEach((elHTML) =>
              container.insertAdjacentHTML("afterbegin", elHTML)
            );
          const scrollDiff = container.scrollWidth - prevScrollWidth;
          container.scrollLeft = prevScrollLeft + scrollDiff;
        } else {
          items.forEach((elHTML) =>
            container.insertAdjacentHTML("beforeend", elHTML)
          );
        }

        isLoading = false;
      }

      async function initialize() {
        const from = activeItem - visibleBefore;
        const to = activeItem + visibleAfter;
        await loadItems(from, to);

        requestAnimationFrame(() => {
          const activeEl = container.querySelector(".course-card.active");
          if (activeEl) {
            const left = activeEl.offsetLeft;
            container.scrollTo({
              left: left - container.clientWidth / 2 + activeEl.offsetWidth / 2,
              behavior: "smooth",
            });
          }
        });
      }

      let debounceTimer = null;

      container.addEventListener(
        "wheel",
        function (event) {
          if (event.deltaY !== 0) {
            event.preventDefault();
            container.scrollLeft += event.deltaY;
          }
        },
        { passive: false }
      );

      container.addEventListener("scroll", () => {
        if (isLoading) return;

        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
          const scrollLeft = container.scrollLeft;
          const scrollRight =
            container.scrollWidth - scrollLeft - container.clientWidth;

          const loadedIndexes = [...loadedItems];
          if (loadedIndexes.length === 0) return;

          const firstItem = Math.min(...loadedIndexes);
          const lastItem = Math.max(...loadedIndexes);

          if (
            scrollLeft < 100 &&
            lastLoadDirection !== "left" &&
            firstItem > 1
          ) {
            lastLoadDirection = "left";
            loadItems(firstItem - 10, firstItem - 1, true).then(() => {
              lastLoadDirection = null;
            });
          }

          if (
            scrollRight < 100 &&
            lastLoadDirection !== "right" &&
            lastItem < totalItems
          ) {
            lastLoadDirection = "right";
            loadItems(lastItem + 1, lastItem + 10, false).then(() => {
              lastLoadDirection = null;
            });
          }
        }, 100);
      });

      function scrollToNextItem(direction = 1) {
        const items = [...container.querySelectorAll(".course-card")];
        const currentScroll = container.scrollLeft;
        const containerMid = currentScroll + container.clientWidth / 2;

        let centerIndex = items.findIndex((el) => {
          const elLeft = el.offsetLeft;
          const elRight = elLeft + el.offsetWidth;
          return elLeft <= containerMid && elRight >= containerMid;
        });

        if (centerIndex === -1) return;

        const targetIndex = centerIndex + direction;
        const target = items[targetIndex];
        if (!target) return;

        container.scrollTo({
          left:
            target.offsetLeft -
            container.clientWidth / 2 +
            target.offsetWidth / 2,
          behavior: "smooth",
        });
      }

      document.getElementById("left-arrow").addEventListener("click", () => {
        scrollToNextItem(-1);
      });

      document.getElementById("right-arrow").addEventListener("click", () => {
        scrollToNextItem(1);
      });

      initialize();
    </script>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const backBtn = document.getElementById("back-to-active");

        setTimeout(() => {
          const target = document.querySelector(".course-card.active");

          if (target) {
            console.log("Found active card:", target);

            const observer = new IntersectionObserver(
              (entries) => {
                entries.forEach((entry) => {
                  if (!entry.isIntersecting) {
                    backBtn.style.display = "block";
                  } else {
                    backBtn.style.display = "none";
                  }
                });
              },
              {
                root: null,
                threshold: 0.1,
              }
            );

            observer.observe(target);

            // Click nút quay lại vị trí đang học
            backBtn.addEventListener("click", () => {
              target.scrollIntoView({ behavior: "smooth", block: "center" });
            });
          } else {
            console.log("Không tìm thấy .course-card.active");
          }
        }, 1000);
      });
    </script>
  </body>
</html>
